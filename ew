#!/usr/bin/env bash
# =============================================================================
# CY-LLM Engine - ç»Ÿä¸€éƒ¨ç½²å‘½ä»¤è¡Œå·¥å…·
# ç”¨æ³•: ./ew <command> [options]
# =============================================================================
set -e

# é¢œè‰²è¾“å‡º
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# é¡¹ç›®è·¯å¾„
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BACKEND_DIR="$SCRIPT_DIR/EW_AI_Backend"
GATEWAY_DIR="$BACKEND_DIR/gateway"
WORKER_DIR="$BACKEND_DIR/worker"
DEPLOY_DIR="$BACKEND_DIR/deploy"

# é»˜è®¤é…ç½®
DEFAULT_ENV_NAME="${EW_CONDA_ENV:-ew_ai_worker}"
DEFAULT_PYTHON_VERSION="${EW_PYTHON_VERSION:-3.10}"
DEFAULT_PORT="${EW_PORT:-8080}"
DEFAULT_WORKER_PORT="${EW_WORKER_PORT:-50051}"
DEFAULT_ENGINE="${EW_ENGINE:-cuda-vllm}"
# å‘åå…¼å®¹: æ”¯æŒæ–°çš„ CY_LLM_* ç¯å¢ƒå˜é‡, å¦‚æœå®ƒä»¬è¢«è®¾ç½®åˆ™æ˜ å°„åˆ°æ—§çš„ EW_* å˜é‡[ -n "" ] && export EW_PORT=""[ -n "" ] && export EW_WORKER_PORT=""[ -n "" ] && export EW_CONDA_ENV=""[ -n "" ] && export EW_PYTHON_VERSION=""[ -n "" ] && export EW_ENGINE=""[ -n "" ] && export EW_MODEL=""[ -n "" ] && export EW_INTERNAL_TOKEN=""[ -n "" ] && export EW_API_KEY=""

# =============================================================================
# è¾…åŠ©å‡½æ•°
# =============================================================================

info()    { echo -e "${BLUE}[INFO]${NC} $*"; }
success() { echo -e "${GREEN}[OK]${NC} $*"; }
warn()    { echo -e "${YELLOW}[WARN]${NC} $*"; }
error()   { echo -e "${RED}[ERROR]${NC} $*" >&2; }
step()    { echo -e "\n${CYAN}â”â”â” $* â”â”â”${NC}"; }

check_command() {
    command -v "$1" &>/dev/null
}

get_conda() {
    if check_command conda; then
        echo "conda"
    elif check_command mamba; then
        echo "mamba"
    elif [[ -f "$HOME/miniforge3/bin/conda" ]]; then
        echo "$HOME/miniforge3/bin/conda"
    elif [[ -f "$HOME/miniconda3/bin/conda" ]]; then
        echo "$HOME/miniconda3/bin/conda"
    else
        error "Conda/Mamba æœªæ‰¾åˆ°ï¼Œè¯·å…ˆå®‰è£… Miniforge/Miniconda"
        exit 1
    fi
}

get_python_path() {
    local env_name="${1:-$DEFAULT_ENV_NAME}"
    local conda_cmd=$(get_conda)
    $conda_cmd run -n "$env_name" which python 2>/dev/null
}

# =============================================================================
# å‘½ä»¤: setup - åˆå§‹åŒ–ç¯å¢ƒ
# =============================================================================
cmd_setup() {
    local env_name="$DEFAULT_ENV_NAME"
    local python_version="$DEFAULT_PYTHON_VERSION"
    local engine="$DEFAULT_ENGINE"
# å‘åå…¼å®¹: æ”¯æŒæ–°çš„ CY_LLM_* ç¯å¢ƒå˜é‡, å¦‚æœå®ƒä»¬è¢«è®¾ç½®åˆ™æ˜ å°„åˆ°æ—§çš„ EW_* å˜é‡[ -n "" ] && export EW_PORT=""[ -n "" ] && export EW_WORKER_PORT=""[ -n "" ] && export EW_CONDA_ENV=""[ -n "" ] && export EW_PYTHON_VERSION=""[ -n "" ] && export EW_ENGINE=""[ -n "" ] && export EW_MODEL=""[ -n "" ] && export EW_INTERNAL_TOKEN=""[ -n "" ] && export EW_API_KEY=""
    local skip_gradle=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --env)      env_name="$2"; shift 2 ;;
            --python)   python_version="$2"; shift 2 ;;
            --engine)   engine="$2"; shift 2 ;;
            --skip-gradle) skip_gradle=true; shift ;;
            *) shift ;;
        esac
    done

    step "ğŸš€ CY-LLM Engine ç¯å¢ƒåˆå§‹åŒ–"
    
    local conda_cmd=$(get_conda)
    info "ä½¿ç”¨åŒ…ç®¡ç†å™¨: $conda_cmd"
    
    # 1. åˆ›å»º/æ£€æŸ¥ Conda ç¯å¢ƒ
    step "1/3 Python ç¯å¢ƒ"
    if $conda_cmd env list | grep -q "^$env_name "; then
        success "ç¯å¢ƒ '$env_name' å·²å­˜åœ¨"
    else
        info "åˆ›å»ºç¯å¢ƒ '$env_name' (Python $python_version)..."
        $conda_cmd create -n "$env_name" python="$python_version" -y
        success "ç¯å¢ƒåˆ›å»ºå®Œæˆ"
    fi
    
    # 2. å®‰è£… Python ä¾èµ–
    info "å®‰è£… Python ä¾èµ–..."
    case "$engine" in
        cuda-vllm|nvidia)
            $conda_cmd run -n "$env_name" pip install -r "$WORKER_DIR/requirements.txt" -q
            ;;
        cuda-trt)
            $conda_cmd run -n "$env_name" pip install -r "$WORKER_DIR/requirements.txt" -q
            # TensorRT-LLM éœ€è¦ç‰¹æ®Šå®‰è£…
            warn "TensorRT-LLM éœ€è¦ä» NVIDIA å®˜æ–¹è·å–ï¼Œè¯·å‚è€ƒæ–‡æ¡£å®‰è£…"
            ;;
        ascend-*)
            $conda_cmd run -n "$env_name" pip install -r "$WORKER_DIR/requirements_ascend.txt" -q
            ;;
        *)
            $conda_cmd run -n "$env_name" pip install -r "$WORKER_DIR/requirements.txt" -q
            ;;
    esac
    success "ä¾èµ–å®‰è£…å®Œæˆ"
    
    # 3. æ„å»º Gateway (å¯é€‰)
    if [[ "$skip_gradle" == false ]]; then
        step "2/3 Gateway æ„å»º"
        if check_command java; then
            info "æ„å»º Gateway JAR..."
            (cd "$GATEWAY_DIR" && ./gradlew build -x test --quiet)
            success "Gateway æ„å»ºå®Œæˆ"
        else
            warn "Java æœªå®‰è£…ï¼Œè·³è¿‡ Gateway æ„å»º"
        fi
    else
        info "è·³è¿‡ Gateway æ„å»º"
    fi
    
    # 4. å®Œæˆ
    step "3/3 éªŒè¯"
    local python_path=$(get_python_path "$env_name")
    success "Python: $python_path"
    
    echo ""
    success "âœ¨ ç¯å¢ƒåˆå§‹åŒ–å®Œæˆï¼"
    echo ""
    echo -e "ä¸‹ä¸€æ­¥: ${CYAN}./ew start${NC} å¯åŠ¨æœåŠ¡"
    echo -e "        ${CYAN}./ew worker${NC} ä»…å¯åŠ¨ Worker"
}

# =============================================================================
# å‘½ä»¤: start - å¯åŠ¨å®Œæ•´æœåŠ¡ (Gateway + Worker)
# =============================================================================
cmd_start() {
    local env_name="$DEFAULT_ENV_NAME"
    local port="$DEFAULT_PORT"
    local worker_port="$DEFAULT_WORKER_PORT"
    local engine="$DEFAULT_ENGINE"
# å‘åå…¼å®¹: æ”¯æŒæ–°çš„ CY_LLM_* ç¯å¢ƒå˜é‡, å¦‚æœå®ƒä»¬è¢«è®¾ç½®åˆ™æ˜ å°„åˆ°æ—§çš„ EW_* å˜é‡[ -n "" ] && export EW_PORT=""[ -n "" ] && export EW_WORKER_PORT=""[ -n "" ] && export EW_CONDA_ENV=""[ -n "" ] && export EW_PYTHON_VERSION=""[ -n "" ] && export EW_ENGINE=""[ -n "" ] && export EW_MODEL=""[ -n "" ] && export EW_INTERNAL_TOKEN=""[ -n "" ] && export EW_API_KEY=""
    local model=""
    local daemon=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --env)      env_name="$2"; shift 2 ;;
            --port)     port="$2"; shift 2 ;;
            --worker-port) worker_port="$2"; shift 2 ;;
            --engine)   engine="$2"; shift 2 ;;
            --model)    model="$2"; shift 2 ;;
            -d|--daemon) daemon=true; shift ;;
            *) shift ;;
        esac
    done

    step "ğŸŒŸ å¯åŠ¨ CY-LLM Engine æœåŠ¡"
    
    local python_path=$(get_python_path "$env_name")
    if [[ -z "$python_path" ]]; then
        error "ç¯å¢ƒ '$env_name' æœªæ‰¾åˆ°ï¼Œè¯·å…ˆè¿è¡Œ: ./ew setup"
        exit 1
    fi
    
    local jar_path="$GATEWAY_DIR/build/libs/gateway-0.0.1-SNAPSHOT.jar"
    if [[ ! -f "$jar_path" ]]; then
        error "Gateway JAR æœªæ‰¾åˆ°ï¼Œè¯·å…ˆè¿è¡Œ: ./ew setup"
        exit 1
    fi
    
    info "Engine: $engine"
    info "Gateway Port: $port"
    info "Worker Port: $worker_port"
    info "Python: $python_path"
    
    export EW_ENGINE="$engine"
    [[ -n "$model" ]] && export EW_MODEL="$model"
    
    if [[ "$daemon" == true ]]; then
        info "åå°æ¨¡å¼å¯åŠ¨..."
        java -jar "$jar_path" \
            --server.port="$port" \
            --self-deploy.enabled=true \
            --self-deploy.python-executable="$python_path" \
            --self-deploy.worker-dir="$WORKER_DIR" \
            --self-deploy.worker-port="$worker_port" \
            > /tmp/cy-llm-gateway.log 2>&1 &
        echo $! > /tmp/cy-llm-gateway.pid
        success "Gateway PID: $(cat /tmp/cy-llm-gateway.pid)"
        success "æ—¥å¿—: /tmp/cy-llm-gateway.log"
    else
        java -jar "$jar_path" \
            --server.port="$port" \
            --self-deploy.enabled=true \
            --self-deploy.python-executable="$python_path" \
            --self-deploy.worker-dir="$WORKER_DIR" \
            --self-deploy.worker-port="$worker_port"
    fi
}

# =============================================================================
# å‘½ä»¤: worker - ä»…å¯åŠ¨ Worker
# =============================================================================
cmd_worker() {
    local env_name="$DEFAULT_ENV_NAME"
    local port="$DEFAULT_WORKER_PORT"
    local engine="$DEFAULT_ENGINE"
# å‘åå…¼å®¹: æ”¯æŒæ–°çš„ CY_LLM_* ç¯å¢ƒå˜é‡, å¦‚æœå®ƒä»¬è¢«è®¾ç½®åˆ™æ˜ å°„åˆ°æ—§çš„ EW_* å˜é‡[ -n "" ] && export EW_PORT=""[ -n "" ] && export EW_WORKER_PORT=""[ -n "" ] && export EW_CONDA_ENV=""[ -n "" ] && export EW_PYTHON_VERSION=""[ -n "" ] && export EW_ENGINE=""[ -n "" ] && export EW_MODEL=""[ -n "" ] && export EW_INTERNAL_TOKEN=""[ -n "" ] && export EW_API_KEY=""
    local model=""
    local serve=true
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --env)      env_name="$2"; shift 2 ;;
            --port)     port="$2"; shift 2 ;;
            --engine)   engine="$2"; shift 2 ;;
            --model)    model="$2"; shift 2 ;;
            --no-serve) serve=false; shift ;;
            *) shift ;;
        esac
    done

    step "ğŸ”§ å¯åŠ¨ Worker"
    
    local conda_cmd=$(get_conda)
    
    export EW_ENGINE="$engine"
    [[ -n "$model" ]] && export EW_MODEL="$model"
    
    info "Engine: $engine"
    info "Port: $port"
    
    local serve_flag=""
    [[ "$serve" == true ]] && serve_flag="--serve"
    
    $conda_cmd run -n "$env_name" python "$WORKER_DIR/main.py" \
        --port "$port" \
        ${model:+--model "$model"} \
        $serve_flag
}

# =============================================================================
# å‘½ä»¤: docker - Docker Compose éƒ¨ç½²
# =============================================================================
cmd_docker() {
    local action="${1:-up}"
    shift || true
    local engine="$DEFAULT_ENGINE"
# å‘åå…¼å®¹: æ”¯æŒæ–°çš„ CY_LLM_* ç¯å¢ƒå˜é‡, å¦‚æœå®ƒä»¬è¢«è®¾ç½®åˆ™æ˜ å°„åˆ°æ—§çš„ EW_* å˜é‡[ -n "" ] && export EW_PORT=""[ -n "" ] && export EW_WORKER_PORT=""[ -n "" ] && export EW_CONDA_ENV=""[ -n "" ] && export EW_PYTHON_VERSION=""[ -n "" ] && export EW_ENGINE=""[ -n "" ] && export EW_MODEL=""[ -n "" ] && export EW_INTERNAL_TOKEN=""[ -n "" ] && export EW_API_KEY=""
    local scale=1
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --engine)   engine="$2"; shift 2 ;;
            --scale)    scale="$2"; shift 2 ;;
            *) shift ;;
        esac
    done

    step "ğŸ³ Docker éƒ¨ç½²"
    
    cd "$DEPLOY_DIR"
    
    export EW_ENGINE="$engine"
    
    case "$action" in
        up)
            info "å¯åŠ¨å®¹å™¨ (Engine: $engine, Scale: $scale)..."
            case "$engine" in
                ascend-*) docker compose --profile ascend up -d --scale worker-ascend="$scale" ;;
                *)        docker compose up -d --scale worker-nvidia="$scale" ;;
            esac
            success "å®¹å™¨å¯åŠ¨å®Œæˆ"
            docker compose ps
            ;;
        down)
            info "åœæ­¢å®¹å™¨..."
            docker compose --profile ascend down
            success "å®¹å™¨å·²åœæ­¢"
            ;;
        logs)
            docker compose logs -f
            ;;
        ps)
            docker compose ps
            ;;
        build)
            info "æ„å»ºé•œåƒ..."
            docker compose build
            success "é•œåƒæ„å»ºå®Œæˆ"
            ;;
        *)
            error "æœªçŸ¥æ“ä½œ: $action"
            echo "å¯ç”¨æ“ä½œ: up, down, logs, ps, build"
            exit 1
            ;;
    esac
}

# =============================================================================
# å‘½ä»¤: stop - åœæ­¢æœåŠ¡
# =============================================================================
cmd_stop() {
    step "ğŸ›‘ åœæ­¢æœåŠ¡"
    
    if [[ -f /tmp/cy-llm-gateway.pid ]]; then
        local pid=$(cat /tmp/cy-llm-gateway.pid)
        if kill -0 "$pid" 2>/dev/null; then
            kill "$pid"
            rm /tmp/cy-llm-gateway.pid
            success "Gateway (PID $pid) å·²åœæ­¢"
        fi
    fi
    
    # æŸ¥æ‰¾å¹¶åœæ­¢æ‰€æœ‰ç›¸å…³è¿›ç¨‹
    pkill -f "gateway-.*-SNAPSHOT.jar" 2>/dev/null && info "Gateway è¿›ç¨‹å·²åœæ­¢" || true
    pkill -f "worker/main.py" 2>/dev/null && info "Worker è¿›ç¨‹å·²åœæ­¢" || true
    
    success "æœåŠ¡å·²åœæ­¢"
}

# =============================================================================
# å‘½ä»¤: status - æŸ¥çœ‹çŠ¶æ€
# =============================================================================
cmd_status() {
    step "ğŸ“Š æœåŠ¡çŠ¶æ€"
    
    echo -e "\n${CYAN}è¿›ç¨‹çŠ¶æ€:${NC}"
    if pgrep -f "gateway-.*-SNAPSHOT.jar" >/dev/null; then
        success "Gateway: è¿è¡Œä¸­"
    else
        warn "Gateway: æœªè¿è¡Œ"
    fi
    
    if pgrep -f "worker/main.py" >/dev/null; then
        success "Worker: è¿è¡Œä¸­"
    else
        warn "Worker: æœªè¿è¡Œ"
    fi
    
    echo -e "\n${CYAN}ç«¯å£ç›‘å¬:${NC}"
    ss -tlnp 2>/dev/null | grep -E ":8080|:50051" || echo "  æ— ç›¸å…³ç«¯å£ç›‘å¬"
    
    echo -e "\n${CYAN}ç¯å¢ƒå˜é‡:${NC}"
    echo "  EW_ENGINE=${EW_ENGINE:-æœªè®¾ç½®}"
    echo "  EW_CONDA_ENV=${EW_CONDA_ENV:-$DEFAULT_ENV_NAME}"
}

# =============================================================================
# å‘½ä»¤: test - è¿è¡Œæµ‹è¯•
# =============================================================================
cmd_test() {
    local env_name="$DEFAULT_ENV_NAME"
    local type="${1:-all}"
    
    step "ğŸ§ª è¿è¡Œæµ‹è¯•"
    
    local conda_cmd=$(get_conda)
    
    case "$type" in
        integration|int)
            info "è¿è¡Œé›†æˆæµ‹è¯•..."
            $conda_cmd run -n "$env_name" python "$BACKEND_DIR/tests/test_integration.py"
            ;;
        unit)
            info "è¿è¡Œå•å…ƒæµ‹è¯•..."
            (cd "$GATEWAY_DIR" && ./gradlew test)
            ;;
        all)
            cmd_test integration
            cmd_test unit
            ;;
        *)
            error "æœªçŸ¥æµ‹è¯•ç±»å‹: $type"
            echo "å¯ç”¨ç±»å‹: integration, unit, all"
            exit 1
            ;;
    esac
}

# =============================================================================
# å‘½ä»¤: models - æ¨¡å‹ç®¡ç†
# =============================================================================
cmd_models() {
    local env_name="$DEFAULT_ENV_NAME"
    local action="${1:-list}"
    
    local conda_cmd=$(get_conda)
    
    case "$action" in
        list|ls)
            step "ğŸ“¦ å¯ç”¨æ¨¡å‹"
            $conda_cmd run -n "$env_name" python "$WORKER_DIR/main.py" --list-models
            ;;
        *)
            error "æœªçŸ¥æ“ä½œ: $action"
            echo "å¯ç”¨æ“ä½œ: list"
            exit 1
            ;;
    esac
}

# =============================================================================
# å‘½ä»¤: help - å¸®åŠ©ä¿¡æ¯
# =============================================================================
cmd_help() {
    cat << 'EOF'
CY-LLM Engine - ç»Ÿä¸€éƒ¨ç½²å‘½ä»¤è¡Œå·¥å…·

ç”¨æ³•: ./ew <command> [options]

å‘½ä»¤:
  setup       åˆå§‹åŒ–ç¯å¢ƒ (Conda + ä¾èµ– + Gateway æ„å»º)
  start       å¯åŠ¨å®Œæ•´æœåŠ¡ (Gateway + Worker)
  worker      ä»…å¯åŠ¨ Worker
  stop        åœæ­¢æ‰€æœ‰æœåŠ¡
  status      æŸ¥çœ‹æœåŠ¡çŠ¶æ€
  docker      Docker Compose éƒ¨ç½²
  test        è¿è¡Œæµ‹è¯•
  models      æ¨¡å‹ç®¡ç†
  help        æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯

å¸¸ç”¨é€‰é¡¹:
  --env NAME        Conda ç¯å¢ƒåç§° (é»˜è®¤: ew_ai_worker)
  --engine TYPE     æ¨ç†å¼•æ“ç±»å‹:
                      cuda-vllm   - NVIDIA GPU + vLLM (æ¨è)
                      cuda-trt    - NVIDIA GPU + TensorRT-LLM
                      ascend-vllm - åä¸º NPU + vLLM-Ascend
                      ascend-mindie - åä¸º NPU + MindIE Turbo
  --port PORT       Gateway ç«¯å£ (é»˜è®¤: 8080)
  --model ID        æ¨¡å‹ ID

ç¤ºä¾‹:
  # åˆå§‹åŒ–ç¯å¢ƒ
  ./ew setup --engine cuda-vllm

  # å¯åŠ¨æœåŠ¡
  ./ew start --engine cuda-vllm --model deepseek-v3

  # åå°å¯åŠ¨
  ./ew start -d

  # Docker éƒ¨ç½²
  ./ew docker up --engine cuda-vllm --scale 2

  # æŸ¥çœ‹çŠ¶æ€
  ./ew status

ç¯å¢ƒå˜é‡:
  EW_ENGINE         é»˜è®¤æ¨ç†å¼•æ“
  EW_CONDA_ENV      é»˜è®¤ Conda ç¯å¢ƒå
  EW_PORT           é»˜è®¤ Gateway ç«¯å£
  EW_WORKER_PORT    é»˜è®¤ Worker ç«¯å£

æ›´å¤šä¿¡æ¯: https://github.com/your-repo/CY-LLM-Engine
EOF
}

# =============================================================================
# ä¸»å…¥å£
# =============================================================================
main() {
    local command="${1:-help}"
    shift || true
    
    case "$command" in
        setup)      cmd_setup "$@" ;;
        start)      cmd_start "$@" ;;
        worker)     cmd_worker "$@" ;;
        docker)     cmd_docker "$@" ;;
        stop)       cmd_stop "$@" ;;
        status)     cmd_status "$@" ;;
        test)       cmd_test "$@" ;;
        models)     cmd_models "$@" ;;
        help|--help|-h) cmd_help ;;
        *)
            error "æœªçŸ¥å‘½ä»¤: $command"
            echo "è¿è¡Œ './ew help' æŸ¥çœ‹å¸®åŠ©"
            exit 1
            ;;
    esac
}

main "$@"
