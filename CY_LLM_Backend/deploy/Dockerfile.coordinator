# Dockerfile.coordinator
# Coordinator 服务 Dockerfile
# 用于构建 Kotlin/Spring Boot 协调器服务

# Use a glibc-based Temurin image so native protoc-gen-grpc binaries can run (avoid musl/alpine)
FROM eclipse-temurin:21-jdk AS builder

WORKDIR /app

# Ensure Gradle picks a valid Java home when building inside this container
ENV ORG_GRADLE_JAVA_HOME=/opt/java/openjdk
ENV JAVA_HOME=/opt/java/openjdk

# 复制 Gradle Wrapper
COPY coordinator/gradlew coordinator/gradlew
COPY coordinator/gradle coordinator/gradle/
RUN chmod +x coordinator/gradlew

# Ensure curl is present (Debian based image) and download a Linux protoc-gen-grpc-java binary into PATH for the build
RUN apt-get update && apt-get install -y curl ca-certificates \
		&& curl -fSL -o /usr/local/bin/protoc-gen-grpc-java \
			https://repo1.maven.org/maven2/io/grpc/protoc-gen-grpc-java/1.65.1/protoc-gen-grpc-java-1.65.1-linux-x86_64.exe \
		&& chmod +x /usr/local/bin/protoc-gen-grpc-java

# 复制构建文件
COPY coordinator/build.gradle.kts coordinator/
COPY coordinator/settings.gradle.kts coordinator/
COPY coordinator/gradle.properties coordinator/

# 复制 Proto 文件
COPY proto/ proto/

# 下载依赖（利用 Docker 缓存）
WORKDIR /app/coordinator
# Explicitly pass a compatible Java home to Gradle when building in the container
RUN ./gradlew dependencies --no-daemon -Dorg.gradle.java.home=/opt/java/openjdk || true

# Some downloaded protoc plugins may not be executable (or may be named with .exe). Ensure any
# matching protoc-gen-grpc-java files are executable so Gradle can invoke them.
RUN find /root/.gradle -type f -name "protoc-gen-grpc-java*" -exec chmod +x {} \; || true
RUN find /root/.gradle -type f -name "*.exe" -exec chmod +x {} \; || true

# 复制源代码并构建
COPY coordinator/src src/
RUN ./gradlew bootJar --no-daemon -Dorg.gradle.java.home=/opt/java/openjdk

# ========== 运行时镜像 ==========
FROM eclipse-temurin:21-jre

LABEL maintainer="CY-LLM Team"
LABEL description="CY-LLM Coordinator Service"

# 安装运行时依赖 (Debian-based image)
RUN apt-get update && apt-get install -y curl ca-certificates

WORKDIR /app

# 从构建阶段复制 JAR
COPY --from=builder /app/coordinator/build/libs/*.jar app.jar

# 创建非 root 用户 (groupadd + useradd for Debian-based images)
RUN groupadd -r cyllm && useradd -r -g cyllm -M -s /sbin/nologin cyllm || true
USER cyllm

# 环境变量
ENV JAVA_OPTS="-XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0"
ENV SPRING_PROFILES_ACTIVE=docker

# 暴露端口
EXPOSE 50050 8081

# 启动命令
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]
